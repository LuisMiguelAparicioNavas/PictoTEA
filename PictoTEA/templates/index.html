<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PictoTEA - P√°gina Principal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous">
  <link rel="stylesheet" href="../static/styleIndex.css" />
</head>

<body> 
  <div class="desktop-container"> 
    <header class="main-header"> 
      <img src="https://cdn.builder.io/api/v1/image/assets/f0b15cc2a8ae43579bc8368b49492d98/9233293e785cf2d5996362ef1e325e83289fe200?placeholderIfAbsent=true" alt="Logo PictoTEA" class="header-logo" /> <h1 class="header-title"><p style = "font-family: sans-serif;"><b>PictoTEA</b></h1> <nav class="header-nav"> 
      <img src="https://cdn.builder.io/api/v1/image/assets/f0b15cc2a8ae43579bc8368b49492d98/0e32348f5f5c862510f61e25587f41b98423bd7f?placeholderIfAbsent=true" alt="Icono p√°gina principal" class="nav-icon" /> <a href="{{ url_for('index') }}" class="nav-link nav-link-active">P√°gina principal</a> 
      <img src="https://cdn.builder.io/api/v1/image/assets/f0b15cc2a8ae43579bc8368b49492d98/816f32e9d79d2195d1943e6f147b39579919548f?placeholderIfAbsent=true" alt="Icono pictos" class="nav-icon" /> <a href="{{ url_for('libreriaPictos') }}" class="nav-link">Pictos</a> </nav> 
    </header>

    <main class="main-content">
      <div class="content-wrapper">
        <button class="phrases-tag"><a href="{{ url_for('frases.tus_frases') }}" class = "enlace-tusfrases" id="irTusFrases">Tus frases</button></a>
        <h2 class="main-question">¬øQu√© quieres decir?</h2>

        <div class="phrase-display">
          <div class="phrase-input">
            <input
              id="inputFrase"
              type="text"
              name="traduccion"
              placeholder="Escribe aqui"
              style="flex-grow: 1; border: none; outline: none; padding: 8px;"
            />
            <div class="search-actions">
              <button id="btnFrase" class="button-busqueda">
                <img
                  src="https://cdn.builder.io/api/v1/image/assets/f0b15cc2a8ae43579bc8368b49492d98/87e701f195307c11441130acc4d4053b3a23a325?placeholderIfAbsent=true"
                  alt="Buscar"
                  class="action-icon search-icon"
                />
              </button>
              <!-- Bot√≥n de Hablar con su ID -->
              <button id="btnHablar" class="button-busqueda">
                <img
                  src="https://cdn.builder.io/api/v1/image/assets/f0b15cc2a8ae43579bc8368b49492d98/35e8cd3fab0d131bb733ee38267276ce67c316ce?placeholderIfAbsent=true"
                  alt="Hablar"
                  class="action-icon-large search-icon"
                />
              </button>
            </div>
          </div>
        </div>

        <div class="pictogram-grid">
          <!-- Se llena con los resultados de pasar de frase a pictograma -->
        </div>

        <div class="add-wrapper">
          <button class="add-button">
            <span class="add-text">A√±adir</span>
            <img
              src="https://cdn.builder.io/api/v1/image/assets/f0b15cc2a8ae43579bc8368b49492d98/1b26a2036eddc01c7085a3aefaf2eca7b6f9ef4a?placeholderIfAbsent=true"
              alt="A√±adir pictograma"
              class="add-icon"
            />
          </button>
        </div>
      </div>
    </main>

    <footer class="main-footer">
      <a href="login.html" class="logout-link">Cerrar sesi√≥n</a>
    </footer>
  </div>

  <!-- Script al final del body para que los IDs ya existan -->
  <script>
    const btnHablar = document.getElementById("btnHablar");
    const inputFrase = document.getElementById("inputFrase");
    const btnFrase = document.getElementById('btnFrase');
    const pictogramGrid = document.querySelector(".pictogram-grid");

    function createPictograma(palabra, url){
      const div = document.createElement('div');
      div.className = 'cuadrado-verde';
      
      if(url){
        div.innerHTML= `
          <div class="pictogram-column">
            <img src="${url}" alt="Pictograma ${palabra}" class="pictogram-image"/>
          </div>
          <div class="pictogram-text">${palabra}</div>
        `;
      }else{
        div.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; width:100%;">
            <div style="font-size: 72px; color:#666;">‚ùì</div>
          </div>
          <div class="pictogram-text">${palabra}</div>
        `;
      }
      return div;
    }
    async function buscarPictogramas() {
      const frase = inputFrase.value;
      if(!frase){
        pictogramGrid.innerHTML = '';
        return;
      }
      pictogramGrid.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">üîç Buscando pictogramas...</div>';
      try{
        const formData = new FormData();
        formData.append('inputFrase', frase)
        const response = await fetch('/pictogramas', {
          method: 'POST',
          body: formData
        });
        if (!response.ok) {
          throw new Error(`Error del servidor: ${response.status}`);
        }
        const resultados = await response.json();
         if (!resultados || resultados.length === 0) {
          pictogramGrid.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">üòï No se encontraron pictogramas</div>';
          return;
        }
        pictogramGrid.innerHTML = "";
        // Mostrar resultados
        resultados.forEach(([palabra, url]) => {
          const pictogramaElement = createPictograma(palabra, url);
          pictogramGrid.appendChild(pictogramaElement);
        });
      }catch (error) {
        console.error('Error al buscar pictogramas:', error);
        pictogramGrid.innerHTML = '<div style="text-align:center; padding:40px; color:#dc3545;">‚ùå Error al buscar pictogramas</div>';
      }
    }
    //Event listeners
    btnFrase.addEventListener("click", buscarPictogramas);
    // Limpiar pictogramas cuando se borra el input
    inputFrase.addEventListener("input", () => {
      if (!inputFrase.value.trim()) {
        pictogramGrid.innerHTML = '';
      }
    });
    btnHablar.addEventListener("click", async () => {
      // Feedback inmediato
      inputFrase.value = "Grabando‚Ä¶";

      // 1. Pedir permiso y grabar audio
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const recorder = new MediaRecorder(stream);
      let chunks = [];
      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.start();

      // 2. Detener grabaci√≥n tras 5 segundos
      setTimeout(() => recorder.stop(), 5000);

      recorder.onstop = async () => {
        // 3. Montar blob y enviarlo al backend
        const blob = new Blob(chunks, { type: "audio/webm" });
        const form = new FormData();
        form.append("audio", blob, "voz.webm");

        try {
          const resp = await fetch("/transcribe", {
            method: "POST",
            body: form
          });
          const j = await resp.json();
          inputFrase.value = j.texto;
        } catch (err) {
          console.error(err);
          inputFrase.value = "Error al transcribir";
        }
      };
    });
  </script>
  <!-- Final script whisper -->

  <!-- Inicio script logica de tus frases -->
  <script>
      document.addEventListener("DOMContentLoaded", () => {
      const botonA√±adir = document.querySelector('.add-button');
      const irTusFrases = document.getElementById('irTusFrases');
      const inputFrase = document.getElementById('inputFrase');

      // Funci√≥n para obtener usuario logeado (simulado con localStorage)
      function usuarioLogeado() {
        return localStorage.getItem('usuarioLogeado'); // o null si no est√°
      }

      // A√±adir frase al backend
      async function a√±adirFraseBackend(email, frase) {
        try {
          const response = await fetch('/a√±adirFrase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, frase: frase })
          });
          if (!response.ok) {
            throw new Error('Error al a√±adir frase');
          }
          return true;
        } catch (error) {
          console.error(error);
          return false;
        }
      }

      // Bot√≥n A√±adir
      if (botonA√±adir) {
        botonA√±adir.addEventListener('click', async () => {
          const usuario = usuarioLogeado();
          const frase = inputFrase.value.trim();

          if (!usuario && frase.length > 0) {
            // Sin login + frase -> redirigir login + guardar frase para a√±adir despu√©s
            localStorage.setItem('frasePendiente', frase);
            window.location.href = '/login';
          } else if (!usuario && frase.length === 0) {
            // Sin login + sin frase -> redirigir login
            window.location.href = '/login';
          } else if (usuario && frase.length === 0) {
            // Login + sin frase -> mensaje temporal
            alert('Primero debes escribir una frase para guardarla');
          } else if (usuario && frase.length > 0) {
            // Login + frase -> a√±adir frase en backend
            const exito = await a√±adirFraseBackend(usuario, frase);
            if (exito) {
              alert('A√±adido correctamente');
              inputFrase.value = '';
            } else {
              alert('Error al a√±adir la frase. Int√©ntalo de nuevo.');
            }
          }
        });
      }

      // Bot√≥n Tus frases
      if (irTusFrases) {
        irTusFrases.addEventListener('click', (e) => {
          e.preventDefault();
          const usuario = usuarioLogeado();
          if (!usuario) {
            window.location.href = '/login';
          } else {
            window.location.href = '/tusFrases';
          }
        });
      }

      // Comprobar si hay frase pendiente tras login
      const frasePendiente = localStorage.getItem('frasePendiente');
      if (frasePendiente && usuarioLogeado()) {
        // Intentar a√±adir la frase pendiente
        (async () => {
          const usuario = usuarioLogeado();
          const exito = await a√±adirFraseBackend(usuario, frasePendiente);
          if (exito) {
            alert('A√±adido correctamente');
            localStorage.removeItem('frasePendiente');
            inputFrase.value = '';
          } else {
            alert('Error al a√±adir la frase pendiente.');
          }
        })();
      }
    });

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
</body>
</html>
